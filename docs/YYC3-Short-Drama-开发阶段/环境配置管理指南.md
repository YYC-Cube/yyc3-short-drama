# 环境配置管理指南

## 概述

本文档详细描述YYC3-Short-Drama项目的环境配置管理方案，确保不同环境（开发、测试、生产）的配置隔离和管理，按照YYC³标准规范进行开发和实施。

## 1. 环境配置文件结构

### 1.1 配置文件说明

| 配置文件 | 用途 | 环境 | 是否提交到版本控制 |
|---------|------|------|------------------|
| `.env.example` | 配置示例文件，包含所有可用的环境变量 | 通用 | ✅ 是 |
| `.env.development` | 开发环境配置 | 开发 | ✅ 是 (不含敏感信息) |
| `.env.test` | 测试环境配置 | 测试 | ✅ 是 (不含敏感信息) |
| `.env.production` | 生产环境配置模板 | 生产 | ✅ 是 (不含敏感信息) |
| `.env.local` | 本地开发配置，覆盖默认配置 | 本地 | ❌ 否 |
| `.env` | 默认配置文件 | 通用 | ❌ 否 |

### 1.2 配置文件优先级

Next.js 环境变量加载优先级（从高到低）：

1. `.env.local` - 本地开发配置，会覆盖其他所有配置
2. `.env.${NODE_ENV}` - 特定环境的配置文件
3. `.env` - 默认配置文件

## 2. 环境隔离配置

### 2.1 开发环境 (development)

**配置文件**: `.env.development`

**特点**:
- 使用本地数据库
- 启用详细日志
- 禁用速率限制
- 使用测试API密钥
- 端口: 3200

**启动命令**:
```bash
# 使用开发环境配置启动
npm run dev
```

### 2.2 测试环境 (test)

**配置文件**: `.env.test`

**特点**:
- 使用独立的测试数据库
- 禁用邮件发送
- 禁用备份
- 使用测试API密钥
- 端口: 3201

**启动命令**:
```bash
# 使用测试环境配置启动
NODE_ENV=test npm run start
```

### 2.3 生产环境 (production)

**配置文件**: `.env.production`

**特点**:
- 使用生产数据库
- 启用详细日志
- 启用速率限制
- 使用真实API密钥
- 端口: 3200
- 启用HTTPS

**启动命令**:
```bash
# 使用生产环境配置启动
NODE_ENV=production npm start
```

## 3. 敏感信息管理

### 3.1 敏感信息分类

| 信息类型 | 示例 | 处理方式 |
|---------|------|---------|
| **数据库密码** | `DB_MASTER_PASS` | 存储在环境变量或密钥管理服务 |
| **API密钥** | `OPENAI_API_KEY` | 存储在环境变量或密钥管理服务 |
| **加密密钥** | `JWT_SECRET` | 存储在环境变量或密钥管理服务 |
| **邮件密码** | `SMTP_PASS` | 存储在环境变量或密钥管理服务 |
| **短信服务密钥** | `ALIYUN_ACCESS_KEY_SECRET` | 存储在环境变量或密钥管理服务 |

### 3.2 敏感信息处理

1. **开发和测试环境**:
   - 使用测试用的API密钥
   - 数据库密码可以存储在配置文件中（仅用于测试环境）
   - 确保测试环境的配置文件不包含真实的敏感信息

2. **生产环境**:
   - 所有敏感信息必须通过环境变量注入
   - 不得将敏感信息存储在配置文件中
   - 使用密钥管理服务（如AWS Secrets Manager、阿里云KMS等）
   - 定期轮换密钥和密码

### 3.3 配置文件安全

- **`.env.local`** 文件必须添加到 `.gitignore` 中
- **生产环境**的敏感配置必须通过环境变量注入
- 定期检查配置文件，确保没有敏感信息泄露
- 使用不同的密钥和密码用于不同的环境

## 4. 环境变量管理

### 4.1 环境变量分类

| 分类 | 前缀 | 示例 |
|------|------|------|
| **数据库配置** | `DB_` | `DB_MASTER_HOST` |
| **认证配置** | `JWT_`, `REFRESH_TOKEN_` | `JWT_SECRET` |
| **邮件配置** | `SMTP_` | `SMTP_HOST` |
| **短信配置** | `SMS_`, `ALIYUN_` | `SMS_SIGN_NAME` |
| **AI服务配置** | `OPENAI_`, `GROQ_` | `OPENAI_API_KEY` |
| **文件存储配置** | `FILE_`, `LOCAL_`, `OSS_` | `FILE_STORAGE_TYPE` |
| **API服务配置** | `SERVICE_`, `API_` | `SERVICE_USER_URL` |
| **应用配置** | `PORT`, `NEXT_PUBLIC_` | `PORT` |
| **安全配置** | `CORS_`, `CSRF_`, `RATE_LIMIT_` | `CORS_ORIGIN` |
| **监控配置** | `LOG_`, `SENTRY_`, `PERFORMANCE_` | `LOG_LEVEL` |
| **支付配置** | `STRIPE_`, `ALIPAY_`, `WECHAT_PAY_` | `STRIPE_SECRET_KEY` |
| **第三方集成配置** | `GOOGLE_`, `WECHAT_`, `WEIBO_` | `GOOGLE_CLIENT_ID` |
| **特性开关配置** | `FEATURE_` | `FEATURE_AI_SCRIPT` |
| **部署配置** | `DEPLOYMENT_`, `MAINTENANCE_`, `BACKUP_` | `DEPLOYMENT_ENV` |
| **RabbitMQ配置** | `RABBITMQ_` | `RABBITMQ_HOST` |
| **事件总线配置** | `EVENT_BUS_` | `EVENT_BUS_ENABLED` |

### 4.2 环境变量验证

项目使用 Zod 进行环境变量验证，确保所有必需的环境变量都已设置，并且格式正确。

**验证文件**: `lib/env.ts`

验证规则：
- 必需的环境变量必须设置
- 环境变量值必须符合指定的格式
- 提供合理的默认值（对于非必需的环境变量）
- 在测试环境中提供默认值，避免进程退出

### 4.3 环境变量使用

在代码中使用环境变量时，应通过 `lib/env.ts` 导入验证后的环境变量，而不是直接使用 `process.env`。

**正确用法**:
```typescript
import { env } from '@/lib/env';

const dbHost = env.DB_MASTER_HOST;
const jwtSecret = env.JWT_SECRET;
```

**错误用法**:
```typescript
const dbHost = process.env.DB_MASTER_HOST;
const jwtSecret = process.env.JWT_SECRET;
```

## 5. 多环境部署配置

### 5.1 Docker 部署

**Dockerfile 示例**:

```dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm install

COPY . .

# 构建应用
RUN npm run build

# 暴露端口
EXPOSE 3200

# 启动应用
CMD ["npm", "start"]
```

**Docker Compose 配置**:

```yaml
# docker-compose.yml (开发环境)
version: '3.8'

services:
  app:
    build: .
    ports:
      - "3200:3200"
    environment:
      - NODE_ENV=development
    volumes:
      - .:/app
      - /app/node_modules
    depends_on:
      - db
      - redis
      - rabbitmq

  db:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: yyc3_dev
      MYSQL_USER: yyc3_dj
      MYSQL_PASSWORD: yyc3_dj
    ports:
      - "3306:3306"

  redis:
    image: redis:7.0
    ports:
      - "6379:6379"

  rabbitmq:
    image: rabbitmq:3.12-management
    ports:
      - "5672:5672"
      - "15672:15672"
```

### 5.2 Kubernetes 部署

**配置示例**:

```yaml
# kubernetes/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: yyc3-short-drama
spec:
  replicas: 3
  selector:
    matchLabels:
      app: yyc3-short-drama
  template:
    metadata:
      labels:
        app: yyc3-short-drama
    spec:
      containers:
      - name: yyc3-short-drama
        image: yyc3/short-drama:latest
        ports:
        - containerPort: 3200
        envFrom:
        - configMapRef:
            name: yyc3-short-drama-config
        - secretRef:
            name: yyc3-short-drama-secrets
```

**配置映射**:

```yaml
# kubernetes/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: yyc3-short-drama-config
data:
  NODE_ENV: production
  PORT: "3200"
  NEXT_PUBLIC_APP_URL: "https://www.0379.email"
  NEXT_PUBLIC_API_URL: "https://www.0379.email/api"
  # 其他非敏感配置...
```

**密钥配置**:

```yaml
# kubernetes/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: yyc3-short-drama-secrets
type: Opaque
data:
  DB_MASTER_PASS: <base64-encoded-password>
  JWT_SECRET: <base64-encoded-secret>
  OPENAI_API_KEY: <base64-encoded-key>
  # 其他敏感配置...
```

## 6. 环境切换指南

### 6.1 本地开发环境

**步骤**:

1. 确保 `.env.development` 文件存在且配置正确
2. 启动开发服务器:
   ```bash
   npm run dev
   ```

**本地覆盖配置**:

如果需要在本地覆盖某些配置，可以创建 `.env.local` 文件：

```bash
# 创建本地配置文件
cp .env.development .env.local

# 编辑 .env.local 文件，修改需要覆盖的配置
```

### 6.2 测试环境

**步骤**:

1. 确保 `.env.test` 文件存在且配置正确
2. 启动测试环境服务器:
   ```bash
   NODE_ENV=test npm run start
   ```

**运行测试**:

```bash
# 运行单元测试
npm test

# 运行集成测试
npm run test:integration
```

### 6.3 生产环境

**步骤**:

1. 准备生产环境配置:
   - 复制 `.env.production` 到服务器
   - 替换敏感信息为实际值
   - 或使用环境变量注入敏感信息

2. 构建应用:
   ```bash
   NODE_ENV=production npm run build
   ```

3. 启动生产环境服务器:
   ```bash
   NODE_ENV=production npm start
   ```

## 7. 配置变更管理

### 7.1 配置变更流程

1. **变更申请**:
   - 填写配置变更申请表，说明变更原因、变更内容和影响范围
   - 获得相关人员批准

2. **变更实施**:
   - 在测试环境中测试变更
   - 确保变更不会破坏系统功能
   - 记录变更内容和时间

3. **变更验证**:
   - 验证系统功能是否正常
   - 监控系统性能和错误率
   - 确保变更达到预期效果

4. **变更回滚**:
   - 如变更导致问题，立即回滚到之前的配置
   - 分析问题原因并重新评估变更

### 7.2 配置版本控制

- 所有配置文件（除敏感信息外）应提交到版本控制
- 使用Git标签标记重要的配置变更
- 记录配置变更历史，便于追踪和回滚

## 8. 最佳实践

### 8.1 配置管理最佳实践

- **使用环境变量**：对于敏感信息，使用环境变量而不是配置文件
- **配置隔离**：不同环境使用不同的配置文件，确保环境隔离
- **配置验证**：使用Zod等工具验证环境变量的正确性
- **默认值**：为非必需的环境变量提供合理的默认值
- **文档化**：记录所有环境变量的用途和默认值
- **版本控制**：将配置文件（不含敏感信息）提交到版本控制
- **定期审查**：定期审查配置文件，确保没有敏感信息泄露

### 8.2 安全最佳实践

- **密钥轮换**：定期轮换密钥和密码
- **最小权限**：为数据库用户和服务账号设置最小权限
- **加密存储**：敏感信息应加密存储
- **访问控制**：限制对配置文件的访问权限
- **审计日志**：记录配置变更的审计日志

### 8.3 部署最佳实践

- **自动化部署**：使用CI/CD流水线自动化部署过程
- **配置管理**：使用配置管理工具（如Ansible、Puppet）管理配置
- **环境一致性**：确保测试环境与生产环境的配置尽可能一致
- **监控**：监控配置变更对系统的影响
- **回滚机制**：建立配置变更的回滚机制

## 9. 故障排除

### 9.1 常见问题

| 问题 | 可能原因 | 解决方案 |
|------|---------|---------|
| **环境变量未加载** | 配置文件不存在或格式错误 | 检查配置文件是否存在，格式是否正确 |
| **敏感信息泄露** | 配置文件包含敏感信息并提交到版本控制 | 从版本控制中删除敏感信息，修改相关密码 |
| **环境配置错误** | 环境变量值不正确 | 检查环境变量值是否正确，重启服务 |
| **配置冲突** | 多个配置文件同时存在，导致配置冲突 | 检查配置文件优先级，确保使用正确的配置文件 |
| **数据库连接失败** | 数据库配置错误 | 检查数据库连接字符串和凭据是否正确 |

### 9.2 排查步骤

1. **检查环境变量**:
   ```bash
   # 查看当前环境变量
   printenv | grep -E "DB_|JWT_|SMTP_|OPENAI_"
   ```

2. **检查配置文件**:
   ```bash
   # 查看当前使用的配置文件
   ls -la .env*
   
   # 查看配置文件内容
   cat .env.development
   ```

3. **检查应用日志**:
   ```bash
   # 查看应用日志
   tail -f logs/app.log
   ```

4. **验证环境变量加载**:
   ```bash
   # 运行环境变量验证脚本
   node -e "require('./lib/env'); console.log('环境变量验证成功');"
   ```

## 10. 总结

环境配置管理是YYC3-Short-Drama项目的重要组成部分，通过合理的配置管理方案，可以确保不同环境的配置隔离和管理，提高系统的可靠性和安全性。本指南提供了详细的环境配置管理方案，包括配置文件结构、环境隔离配置、敏感信息管理、多环境部署配置等内容，按照YYC³标准规范进行开发和实施。

通过遵循本指南的最佳实践，可以确保项目在不同环境中的稳定运行，同时提高开发和部署的效率。