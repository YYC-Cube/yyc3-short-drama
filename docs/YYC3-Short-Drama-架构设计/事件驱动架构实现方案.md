# äº‹ä»¶é©±åŠ¨æ¶æ„å®ç°æ–¹æ¡ˆ

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°YYC3-Short-Dramaé¡¹ç›®çš„äº‹ä»¶é©±åŠ¨æ¶æ„å®ç°æ–¹æ¡ˆï¼Œç¡®ä¿ç³»ç»ŸæŒ‰ç…§YYCÂ³æ ‡å‡†è§„èŒƒè¿›è¡Œå¼€å‘å’Œå®æ–½ï¼Œå®ç°ç³»ç»Ÿçš„é«˜å¯ç”¨æ€§ã€é«˜æ€§èƒ½ã€é«˜å®‰å…¨æ€§ã€é«˜æ‰©å±•æ€§å’Œé«˜å¯ç»´æŠ¤æ€§ã€‚

## 1. äº‹ä»¶é©±åŠ¨æ¶æ„è®¾è®¡

### 1.1 æ ¸å¿ƒæ¦‚å¿µ

- **äº‹ä»¶**ï¼šç³»ç»Ÿä¸­å‘ç”Ÿçš„é‡è¦äº‹æƒ…ï¼ŒåŒ…å«äº‹ä»¶ç±»å‹å’Œç›¸å…³æ•°æ®
- **äº‹ä»¶å‘å¸ƒè€…**ï¼šç”Ÿæˆå¹¶å‘å¸ƒäº‹ä»¶çš„ç»„ä»¶
- **äº‹ä»¶è®¢é˜…è€…**ï¼šæ¥æ”¶å¹¶å¤„ç†äº‹ä»¶çš„ç»„ä»¶
- **äº‹ä»¶æ€»çº¿**ï¼šè´Ÿè´£äº‹ä»¶çš„åˆ†å‘å’Œè·¯ç”±
- **äº‹ä»¶å¤„ç†å™¨**ï¼šå¤„ç†ç‰¹å®šç±»å‹äº‹ä»¶çš„ç»„ä»¶

### 1.2 æ¶æ„å›¾

```
+----------------+       +----------------+       +----------------+
|                |       |                |       |                |
|  äº‹ä»¶å‘å¸ƒè€…    | ----> |   äº‹ä»¶æ€»çº¿     | ----> |  äº‹ä»¶è®¢é˜…è€…    |
|                |       |                |       |                |
+----------------+       +----------------+       +----------------+
        |                         |                         |
        |                         |                         |
+----------------+       +----------------+       +----------------+
|                |       |                |       |                |
|  ä¸šåŠ¡æœåŠ¡      |       |  æ¶ˆæ¯é˜Ÿåˆ—      |       |  äº‹ä»¶å¤„ç†å™¨    |
|                |       |                |       |                |
+----------------+       +----------------+       +----------------+
```

### 1.3 æŠ€æœ¯é€‰å‹

| ç»„ä»¶ | æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|------|
| **æ¶ˆæ¯é˜Ÿåˆ—** | RabbitMQ | 3.12+ | äº‹ä»¶å­˜å‚¨å’Œåˆ†å‘ |
| **äº‹ä»¶æ€»çº¿** | Node.js + AMQP | - | äº‹ä»¶å‘å¸ƒå’Œè®¢é˜… |
| **åºåˆ—åŒ–** | JSON | - | äº‹ä»¶æ•°æ®åºåˆ—åŒ– |
| **ç›‘æ§** | Prometheus + Grafana | - | äº‹ä»¶å¤„ç†ç›‘æ§ |

## 2. äº‹ä»¶å®šä¹‰

### 2.1 äº‹ä»¶åˆ†ç±»

| äº‹ä»¶ç±»å‹ | æè¿° | ç¤ºä¾‹ |
|---------|------|------|
| **ç”¨æˆ·äº‹ä»¶** | ç”¨æˆ·ç›¸å…³æ“ä½œ | ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€ç™»å‡º |
| **å‰§æœ¬äº‹ä»¶** | å‰§æœ¬ç›¸å…³æ“ä½œ | å‰§æœ¬ç”Ÿæˆã€ä¼˜åŒ–ã€å‘å¸ƒ |
| **æ–‡åŒ–åŸºå› äº‹ä»¶** | æ–‡åŒ–åŸºå› ç›¸å…³æ“ä½œ | æ–‡åŒ–åŸºå› åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ |
| **æ˜Ÿå¸äº‹ä»¶** | æ˜Ÿå¸ç»æµç›¸å…³æ“ä½œ | æ˜Ÿå¸èµšå–ã€æ¶ˆè´¹ã€è½¬è´¦ |
| **ç³»ç»Ÿäº‹ä»¶** | ç³»ç»Ÿçº§æ“ä½œ | æœåŠ¡å¯åŠ¨ã€åœæ­¢ã€é”™è¯¯ |

### 2.2 äº‹ä»¶ç»“æ„

```typescript
interface Event {
  id: string;           // äº‹ä»¶å”¯ä¸€æ ‡è¯†
  type: string;         // äº‹ä»¶ç±»å‹
  source: string;       // äº‹ä»¶æ¥æº
  timestamp: number;    // äº‹ä»¶å‘ç”Ÿæ—¶é—´æˆ³
  data: any;            // äº‹ä»¶æ•°æ®
  correlationId?: string; // å…³è”IDï¼Œç”¨äºè¿½è¸ªäº‹ä»¶é“¾
}
```

### 2.3 å…·ä½“äº‹ä»¶å®šä¹‰

#### ç”¨æˆ·äº‹ä»¶

| äº‹ä»¶åç§° | äº‹ä»¶ç±»å‹ | äº‹ä»¶æ•°æ® |
|---------|---------|----------|
| **ç”¨æˆ·æ³¨å†Œ** | `user.registered` | `{ userId: string, email: string, name: string }` |
| **ç”¨æˆ·ç™»å½•** | `user.loggedIn` | `{ userId: string, email: string, ip: string }` |
| **ç”¨æˆ·ç™»å‡º** | `user.loggedOut` | `{ userId: string }` |
| **ç”¨æˆ·ä¿¡æ¯æ›´æ–°** | `user.updated` | `{ userId: string, changes: object }` |

#### å‰§æœ¬äº‹ä»¶

| äº‹ä»¶åç§° | äº‹ä»¶ç±»å‹ | äº‹ä»¶æ•°æ® |
|---------|---------|----------|
| **å‰§æœ¬ç”Ÿæˆ** | `script.generated` | `{ scriptId: string, userId: string, theme: string }` |
| **å‰§æœ¬ä¼˜åŒ–** | `script.optimized` | `{ scriptId: string, userId: string, optimizationType: string }` |
| **å‰§æœ¬å‘å¸ƒ** | `script.published` | `{ scriptId: string, userId: string, title: string }` |
| **å‰§æœ¬åˆ é™¤** | `script.deleted` | `{ scriptId: string, userId: string }` |

#### æ˜Ÿå¸äº‹ä»¶

| äº‹ä»¶åç§° | äº‹ä»¶ç±»å‹ | äº‹ä»¶æ•°æ® |
|---------|---------|----------|
| **æ˜Ÿå¸èµšå–** | `starcoin.earned` | `{ userId: string, amount: number, reason: string }` |
| **æ˜Ÿå¸æ¶ˆè´¹** | `starcoin.spent` | `{ userId: string, amount: number, purpose: string }` |
| **æ˜Ÿå¸è½¬è´¦** | `starcoin.transferred` | `{ fromUserId: string, toUserId: string, amount: number }` |
| **ä½™é¢æ›´æ–°** | `starcoin.balanceUpdated` | `{ userId: string, balance: number }` |

## 3. äº‹ä»¶æ€»çº¿å®ç°

### 3.1 ç›®å½•ç»“æ„

```
lib/
â”œâ”€â”€ events/
â”‚   â”œâ”€â”€ bus.ts          # äº‹ä»¶æ€»çº¿å®ç°
â”‚   â”œâ”€â”€ types.ts        # äº‹ä»¶ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ publisher.ts    # äº‹ä»¶å‘å¸ƒå™¨
â”‚   â”œâ”€â”€ subscriber.ts   # äº‹ä»¶è®¢é˜…å™¨
â”‚   â”œâ”€â”€ handlers/       # äº‹ä»¶å¤„ç†å™¨
â”‚   â”‚   â”œâ”€â”€ user.handler.ts
â”‚   â”‚   â”œâ”€â”€ script.handler.ts
â”‚   â”‚   â”œâ”€â”€ starcoin.handler.ts
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â””â”€â”€ middlewares/    # äº‹ä»¶ä¸­é—´ä»¶
â”‚       â”œâ”€â”€ logger.ts
â”‚       â”œâ”€â”€ validator.ts
â”‚       â””â”€â”€ index.ts
```

### 3.2 äº‹ä»¶æ€»çº¿æ ¸å¿ƒä»£ç 

```typescript
// lib/events/bus.ts
import amqp from 'amqplib';
import { Event } from './types';
import { env } from '@/lib/env';

class EventBus {
  private connection: amqp.Connection | null = null;
  private channel: amqp.Channel | null = null;
  private exchangeName = 'yyc3_events';
  private isConnected = false;

  async connect(): Promise<void> {
    try {
      this.connection = await amqp.connect({
        hostname: env.RABBITMQ_HOST || 'localhost',
        port: Number(env.RABBITMQ_PORT || '5672'),
        username: env.RABBITMQ_USER || 'guest',
        password: env.RABBITMQ_PASS || 'guest',
        vhost: env.RABBITMQ_VHOST || '/',
      });

      this.channel = await this.connection.createChannel();
      await this.channel.assertExchange(this.exchangeName, 'topic', {
        durable: true,
        autoDelete: false,
      });

      this.isConnected = true;
      console.log('âœ… äº‹ä»¶æ€»çº¿è¿æ¥æˆåŠŸ');
    } catch (error) {
      console.error('âŒ äº‹ä»¶æ€»çº¿è¿æ¥å¤±è´¥:', error);
      throw error;
    }
  }

  async publish(event: Event): Promise<void> {
    if (!this.isConnected || !this.channel) {
      await this.connect();
    }

    try {
      const routingKey = event.type;
      const message = Buffer.from(JSON.stringify(event));

      await this.channel!.publish(this.exchangeName, routingKey, message, {
        persistent: true,
        contentType: 'application/json',
      });

      console.log(`ğŸ“¤ äº‹ä»¶å‘å¸ƒæˆåŠŸ: ${event.type}`, event.id);
    } catch (error) {
      console.error('âŒ äº‹ä»¶å‘å¸ƒå¤±è´¥:', error);
      throw error;
    }
  }

  async subscribe(
    routingKey: string,
    queueName: string,
    handler: (event: Event) => Promise<void>
  ): Promise<void> {
    if (!this.isConnected || !this.channel) {
      await this.connect();
    }

    try {
      const queue = await this.channel!.assertQueue(queueName, {
        durable: true,
        autoDelete: false,
      });

      await this.channel!.bindQueue(queue.queue, this.exchangeName, routingKey);

      await this.channel!.consume(queue.queue, async (message) => {
        if (message) {
          try {
            const event = JSON.parse(message.content.toString()) as Event;
            await handler(event);
            this.channel!.ack(message);
          } catch (error) {
            console.error('âŒ äº‹ä»¶å¤„ç†å¤±è´¥:', error);
            this.channel!.nack(message, false, false);
          }
        }
      });

      console.log(`ğŸ“¥ äº‹ä»¶è®¢é˜…æˆåŠŸ: ${routingKey} -> ${queueName}`);
    } catch (error) {
      console.error('âŒ äº‹ä»¶è®¢é˜…å¤±è´¥:', error);
      throw error;
    }
  }

  async close(): Promise<void> {
    if (this.channel) {
      await this.channel.close();
    }
    if (this.connection) {
      await this.connection.close();
    }
    this.isConnected = false;
    console.log('ğŸ”š äº‹ä»¶æ€»çº¿è¿æ¥å·²å…³é—­');
  }
}

export const eventBus = new EventBus();
export default eventBus;
```

### 3.3 äº‹ä»¶ç±»å‹å®šä¹‰

```typescript
// lib/events/types.ts

export interface Event {
  id: string;
  type: string;
  source: string;
  timestamp: number;
  data: any;
  correlationId?: string;
}

export interface UserRegisteredEvent extends Event {
  type: 'user.registered';
  data: {
    userId: string;
    email: string;
    name: string;
  };
}

export interface ScriptGeneratedEvent extends Event {
  type: 'script.generated';
  data: {
    scriptId: string;
    userId: string;
    theme: string;
  };
}

export interface StarcoinEarnedEvent extends Event {
  type: 'starcoin.earned';
  data: {
    userId: string;
    amount: number;
    reason: string;
  };
}

// æ›´å¤šäº‹ä»¶ç±»å‹å®šä¹‰...

export type EventType = 
  | 'user.registered'
  | 'user.loggedIn'
  | 'user.loggedOut'
  | 'user.updated'
  | 'script.generated'
  | 'script.optimized'
  | 'script.published'
  | 'script.deleted'
  | 'starcoin.earned'
  | 'starcoin.spent'
  | 'starcoin.transferred'
  | 'starcoin.balanceUpdated'
  | 'system.started'
  | 'system.stopped'
  | 'system.error';
```

### 3.4 äº‹ä»¶å‘å¸ƒå™¨

```typescript
// lib/events/publisher.ts
import { Event, EventType } from './types';
import eventBus from './bus';

class EventPublisher {
  async publish<T extends Event>(event: Omit<T, 'id' | 'timestamp'>): Promise<string> {
    const fullEvent: T = {
      ...event,
      id: this.generateEventId(),
      timestamp: Date.now(),
    } as T;

    await eventBus.publish(fullEvent);
    return fullEvent.id;
  }

  private generateEventId(): string {
    return `event_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  }
}

export const eventPublisher = new EventPublisher();
export default eventPublisher;
```

### 3.5 äº‹ä»¶è®¢é˜…å™¨

```typescript
// lib/events/subscriber.ts
import { Event } from './types';
import eventBus from './bus';

class EventSubscriber {
  async subscribe(
    routingKey: string,
    queueName: string,
    handler: (event: Event) => Promise<void>
  ): Promise<void> {
    await eventBus.subscribe(routingKey, queueName, handler);
  }

  async subscribeAll(
    queueName: string,
    handler: (event: Event) => Promise<void>
  ): Promise<void> {
    await eventBus.subscribe('#', queueName, handler);
  }
}

export const eventSubscriber = new EventSubscriber();
export default eventSubscriber;
```

## 4. äº‹ä»¶å¤„ç†å™¨å®ç°

### 4.1 ç”¨æˆ·äº‹ä»¶å¤„ç†å™¨

```typescript
// lib/events/handlers/user.handler.ts
import { Event, UserRegisteredEvent } from '../types';
import { sendWelcomeEmail } from '@/lib/services/email.service';

class UserEventHandler {
  async handleUserRegistered(event: UserRegisteredEvent): Promise<void> {
    try {
      console.log('ğŸ‘¤ å¤„ç†ç”¨æˆ·æ³¨å†Œäº‹ä»¶:', event.data.userId);
      
      // å‘é€æ¬¢è¿é‚®ä»¶
      await sendWelcomeEmail(event.data.email, event.data.name);
      
      // è®°å½•ç”¨æˆ·æ³¨å†Œæ—¥å¿—
      console.log(`âœ… ç”¨æˆ· ${event.data.email} æ³¨å†ŒæˆåŠŸï¼Œå·²å‘é€æ¬¢è¿é‚®ä»¶`);
    } catch (error) {
      console.error('âŒ å¤„ç†ç”¨æˆ·æ³¨å†Œäº‹ä»¶å¤±è´¥:', error);
      throw error;
    }
  }

  async handleUserLoggedIn(event: Event): Promise<void> {
    try {
      console.log('ğŸ‘¤ å¤„ç†ç”¨æˆ·ç™»å½•äº‹ä»¶:', event.data.userId);
      
      // è®°å½•ç™»å½•æ—¥å¿—
      console.log(`âœ… ç”¨æˆ· ${event.data.userId} ç™»å½•æˆåŠŸï¼ŒIP: ${event.data.ip}`);
    } catch (error) {
      console.error('âŒ å¤„ç†ç”¨æˆ·ç™»å½•äº‹ä»¶å¤±è´¥:', error);
      throw error;
    }
  }

  async handleEvent(event: Event): Promise<void> {
    switch (event.type) {
      case 'user.registered':
        await this.handleUserRegistered(event as UserRegisteredEvent);
        break;
      case 'user.loggedIn':
        await this.handleUserLoggedIn(event);
        break;
      case 'user.loggedOut':
        console.log('ğŸ‘¤ ç”¨æˆ·ç™»å‡º:', event.data.userId);
        break;
      case 'user.updated':
        console.log('ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯æ›´æ–°:', event.data.userId);
        break;
      default:
        console.log('ğŸ‘¤ æœªçŸ¥ç”¨æˆ·äº‹ä»¶ç±»å‹:', event.type);
    }
  }
}

export const userEventHandler = new UserEventHandler();
export default userEventHandler;
```

### 4.2 å‰§æœ¬äº‹ä»¶å¤„ç†å™¨

```typescript
// lib/events/handlers/script.handler.ts
import { Event, ScriptGeneratedEvent } from '../types';
import { eventPublisher } from '../publisher';

class ScriptEventHandler {
  async handleScriptGenerated(event: ScriptGeneratedEvent): Promise<void> {
    try {
      console.log('ğŸ“œ å¤„ç†å‰§æœ¬ç”Ÿæˆäº‹ä»¶:', event.data.scriptId);
      
      // ç”Ÿæˆå‰§æœ¬åè‡ªåŠ¨ä¸ºç”¨æˆ·æ·»åŠ æ˜Ÿå¸å¥–åŠ±
      await eventPublisher.publish({
        type: 'starcoin.earned',
        source: 'script.handler',
        data: {
          userId: event.data.userId,
          amount: 10,
          reason: `ç”Ÿæˆå‰§æœ¬: ${event.data.theme}`,
        },
        correlationId: event.id,
      });
      
      console.log(`âœ… å‰§æœ¬ ${event.data.scriptId} ç”ŸæˆæˆåŠŸï¼Œå·²ä¸ºç”¨æˆ·æ·»åŠ æ˜Ÿå¸å¥–åŠ±`);
    } catch (error) {
      console.error('âŒ å¤„ç†å‰§æœ¬ç”Ÿæˆäº‹ä»¶å¤±è´¥:', error);
      throw error;
    }
  }

  async handleScriptOptimized(event: Event): Promise<void> {
    try {
      console.log('ğŸ“œ å¤„ç†å‰§æœ¬ä¼˜åŒ–äº‹ä»¶:', event.data.scriptId);
      
      // è®°å½•å‰§æœ¬ä¼˜åŒ–æ—¥å¿—
      console.log(`âœ… å‰§æœ¬ ${event.data.scriptId} ä¼˜åŒ–æˆåŠŸ`);
    } catch (error) {
      console.error('âŒ å¤„ç†å‰§æœ¬ä¼˜åŒ–äº‹ä»¶å¤±è´¥:', error);
      throw error;
    }
  }

  async handleEvent(event: Event): Promise<void> {
    switch (event.type) {
      case 'script.generated':
        await this.handleScriptGenerated(event as ScriptGeneratedEvent);
        break;
      case 'script.optimized':
        await this.handleScriptOptimized(event);
        break;
      case 'script.published':
        console.log('ğŸ“œ å‰§æœ¬å‘å¸ƒ:', event.data.scriptId);
        break;
      case 'script.deleted':
        console.log('ğŸ“œ å‰§æœ¬åˆ é™¤:', event.data.scriptId);
        break;
      default:
        console.log('ğŸ“œ æœªçŸ¥å‰§æœ¬äº‹ä»¶ç±»å‹:', event.type);
    }
  }
}

export const scriptEventHandler = new ScriptEventHandler();
export default scriptEventHandler;
```

### 4.3 æ˜Ÿå¸äº‹ä»¶å¤„ç†å™¨

```typescript
// lib/events/handlers/starcoin.handler.ts
import { Event, StarcoinEarnedEvent } from '../types';

class StarcoinEventHandler {
  async handleStarcoinEarned(event: StarcoinEarnedEvent): Promise<void> {
    try {
      console.log('â­ å¤„ç†æ˜Ÿå¸èµšå–äº‹ä»¶:', event.data.userId);
      
      // æ›´æ–°ç”¨æˆ·ä½™é¢
      // è¿™é‡Œåº”è¯¥è°ƒç”¨æ˜Ÿå¸æœåŠ¡çš„æ›´æ–°ä½™é¢æ–¹æ³•
      console.log(`âœ… ç”¨æˆ· ${event.data.userId} èµšå– ${event.data.amount} æ˜Ÿå¸ï¼ŒåŸå› : ${event.data.reason}`);
    } catch (error) {
      console.error('âŒ å¤„ç†æ˜Ÿå¸èµšå–äº‹ä»¶å¤±è´¥:', error);
      throw error;
    }
  }

  async handleStarcoinSpent(event: Event): Promise<void> {
    try {
      console.log('â­ å¤„ç†æ˜Ÿå¸æ¶ˆè´¹äº‹ä»¶:', event.data.userId);
      
      // æ›´æ–°ç”¨æˆ·ä½™é¢
      console.log(`âœ… ç”¨æˆ· ${event.data.userId} æ¶ˆè´¹ ${event.data.amount} æ˜Ÿå¸ï¼Œç”¨é€”: ${event.data.purpose}`);
    } catch (error) {
      console.error('âŒ å¤„ç†æ˜Ÿå¸æ¶ˆè´¹äº‹ä»¶å¤±è´¥:', error);
      throw error;
    }
  }

  async handleEvent(event: Event): Promise<void> {
    switch (event.type) {
      case 'starcoin.earned':
        await this.handleStarcoinEarned(event as StarcoinEarnedEvent);
        break;
      case 'starcoin.spent':
        await this.handleStarcoinSpent(event);
        break;
      case 'starcoin.transferred':
        console.log('â­ æ˜Ÿå¸è½¬è´¦:', event.data.fromUserId, '->', event.data.toUserId, event.data.amount);
        break;
      case 'starcoin.balanceUpdated':
        console.log('â­ ä½™é¢æ›´æ–°:', event.data.userId, event.data.balance);
        break;
      default:
        console.log('â­ æœªçŸ¥æ˜Ÿå¸äº‹ä»¶ç±»å‹:', event.type);
    }
  }
}

export const starcoinEventHandler = new StarcoinEventHandler();
export default starcoinEventHandler;
```

## 5. äº‹ä»¶ä¸­é—´ä»¶

### 5.1 æ—¥å¿—ä¸­é—´ä»¶

```typescript
// lib/events/middlewares/logger.ts
import { Event } from '../types';

async function loggerMiddleware(event: Event, next: () => Promise<void>): Promise<void> {
  console.log(`ğŸ“‹ äº‹ä»¶å¤„ç†å¼€å§‹: ${event.type}`, event.id);
  
  try {
    await next();
    console.log(`ğŸ“‹ äº‹ä»¶å¤„ç†æˆåŠŸ: ${event.type}`, event.id);
  } catch (error) {
    console.error(`ğŸ“‹ äº‹ä»¶å¤„ç†å¤±è´¥: ${event.type}`, event.id, error);
    throw error;
  }
}

export default loggerMiddleware;
```

### 5.2 éªŒè¯ä¸­é—´ä»¶

```typescript
// lib/events/middlewares/validator.ts
import { Event } from '../types';

async function validatorMiddleware(event: Event, next: () => Promise<void>): Promise<void> {
  // éªŒè¯äº‹ä»¶ç»“æ„
  if (!event.id || !event.type || !event.source || !event.timestamp) {
    throw new Error('äº‹ä»¶ç»“æ„ä¸å®Œæ•´');
  }

  // éªŒè¯äº‹ä»¶ç±»å‹
  const validEventTypes = [
    'user.registered', 'user.loggedIn', 'user.loggedOut', 'user.updated',
    'script.generated', 'script.optimized', 'script.published', 'script.deleted',
    'starcoin.earned', 'starcoin.spent', 'starcoin.transferred', 'starcoin.balanceUpdated',
    'system.started', 'system.stopped', 'system.error'
  ];

  if (!validEventTypes.includes(event.type)) {
    throw new Error(`æ— æ•ˆçš„äº‹ä»¶ç±»å‹: ${event.type}`);
  }

  await next();
}

export default validatorMiddleware;
```

## 6. ä¸ç°æœ‰ç³»ç»Ÿé›†æˆ

### 6.1 APIè·¯ç”±é›†æˆ

```typescript
// app/api/auth/register/route.ts
import { type NextRequest, NextResponse } from 'next/server';
import { eventPublisher } from '@/lib/events/publisher';

// ... ç°æœ‰ä»£ç  ...

export async function POST(request: NextRequest) {
  try {
    // ... ç°æœ‰æ³¨å†Œé€»è¾‘ ...

    // å‘å¸ƒç”¨æˆ·æ³¨å†Œäº‹ä»¶
    await eventPublisher.publish({
      type: 'user.registered',
      source: 'auth.register',
      data: {
        userId: user.id,
        email: user.email,
        name: user.name,
      },
    });

    return NextResponse.json({
      success: true,
      message: 'æ³¨å†ŒæˆåŠŸ',
      data: { user, token },
    }, { status: 201 });
  } catch (error) {
    // ... é”™è¯¯å¤„ç† ...
  }
}
```

### 6.2 AIå‰§æœ¬ç”Ÿæˆé›†æˆ

```typescript
// app/api/ai-script/generate/route.ts
import { type NextRequest, NextResponse } from 'next/server';
import { eventPublisher } from '@/lib/events/publisher';

// ... ç°æœ‰ä»£ç  ...

export async function POST(request: NextRequest) {
  try {
    // ... ç°æœ‰ç”Ÿæˆå‰§æœ¬é€»è¾‘ ...

    // å‘å¸ƒå‰§æœ¬ç”Ÿæˆäº‹ä»¶
    await eventPublisher.publish({
      type: 'script.generated',
      source: 'ai-script.generate',
      data: {
        scriptId: script.id,
        userId: userId, // ä»tokenä¸­è§£æ
        theme: theme,
      },
    });

    return NextResponse.json({
      success: true,
      message: 'å‰§æœ¬ç”ŸæˆæˆåŠŸ',
      data: { script },
    });
  } catch (error) {
    // ... é”™è¯¯å¤„ç† ...
  }
}
```

### 6.3 æ˜Ÿå¸ç»æµé›†æˆ

```typescript
// app/api/star-economy/earn/route.ts
import { type NextRequest, NextResponse } from 'next/server';
import { eventPublisher } from '@/lib/events/publisher';

// ... ç°æœ‰ä»£ç  ...

export async function POST(request: NextRequest) {
  try {
    // ... ç°æœ‰èµšå–æ˜Ÿå¸é€»è¾‘ ...

    // å‘å¸ƒæ˜Ÿå¸èµšå–äº‹ä»¶
    await eventPublisher.publish({
      type: 'starcoin.earned',
      source: 'star-economy.earn',
      data: {
        userId: userId, // ä»tokenä¸­è§£æ
        amount: amount,
        reason: reason,
      },
    });

    return NextResponse.json({
      success: true,
      message: 'æ˜Ÿå¸èµšå–æˆåŠŸ',
      data: { balance: newBalance },
    });
  } catch (error) {
    // ... é”™è¯¯å¤„ç† ...
  }
}
```

## 7. äº‹ä»¶é©±åŠ¨æ¶æ„å¯åŠ¨å’Œåˆå§‹åŒ–

### 7.1 å¯åŠ¨è„šæœ¬

```typescript
// lib/events/init.ts
import eventBus from './bus';
import eventSubscriber from './subscriber';
import userEventHandler from './handlers/user.handler';
import scriptEventHandler from './handlers/script.handler';
import starcoinEventHandler from './handlers/starcoin.handler';

export async function initEventBus(): Promise<void> {
  try {
    // è¿æ¥äº‹ä»¶æ€»çº¿
    await eventBus.connect();
    
    // è®¢é˜…ç”¨æˆ·äº‹ä»¶
    await eventSubscriber.subscribe(
      'user.*',
      'user_events_queue',
      userEventHandler.handleEvent.bind(userEventHandler)
    );
    
    // è®¢é˜…å‰§æœ¬äº‹ä»¶
    await eventSubscriber.subscribe(
      'script.*',
      'script_events_queue',
      scriptEventHandler.handleEvent.bind(scriptEventHandler)
    );
    
    // è®¢é˜…æ˜Ÿå¸äº‹ä»¶
    await eventSubscriber.subscribe(
      'starcoin.*',
      'starcoin_events_queue',
      starcoinEventHandler.handleEvent.bind(starcoinEventHandler)
    );
    
    // å‘å¸ƒç³»ç»Ÿå¯åŠ¨äº‹ä»¶
    console.log('âœ… äº‹ä»¶é©±åŠ¨æ¶æ„åˆå§‹åŒ–æˆåŠŸ');
  } catch (error) {
    console.error('âŒ äº‹ä»¶é©±åŠ¨æ¶æ„åˆå§‹åŒ–å¤±è´¥:', error);
    throw error;
  }
}

export async function shutdownEventBus(): Promise<void> {
  try {
    await eventBus.close();
    console.log('âœ… äº‹ä»¶é©±åŠ¨æ¶æ„å·²å…³é—­');
  } catch (error) {
    console.error('âŒ å…³é—­äº‹ä»¶é©±åŠ¨æ¶æ„å¤±è´¥:', error);
    throw error;
  }
}
```

### 7.2 åœ¨Next.jsä¸­åˆå§‹åŒ–

```typescript
// app/api/route.ts
import { initEventBus } from '@/lib/events/init';

// åˆå§‹åŒ–äº‹ä»¶æ€»çº¿
let eventBusInitialized = false;

export async function GET() {
  if (!eventBusInitialized) {
    try {
      await initEventBus();
      eventBusInitialized = true;
    } catch (error) {
      console.error('åˆå§‹åŒ–äº‹ä»¶æ€»çº¿å¤±è´¥:', error);
    }
  }

  return Response.json({
    message: 'YYC3 Short Drama API æœåŠ¡è¿è¡Œä¸­',
    timestamp: new Date().toISOString(),
  });
}
```

## 8. ç›‘æ§å’Œè¿ç»´

### 8.1 äº‹ä»¶ç›‘æ§

- **äº‹ä»¶å¤„ç†ç»Ÿè®¡**ï¼šç›‘æ§äº‹ä»¶å¤„ç†çš„æ•°é‡ã€æˆåŠŸç‡ã€å¹³å‡å¤„ç†æ—¶é—´
- **äº‹ä»¶é˜Ÿåˆ—ç›‘æ§**ï¼šç›‘æ§é˜Ÿåˆ—çš„é•¿åº¦ã€æ¶ˆè´¹é€Ÿåº¦ã€å»¶è¿Ÿç­‰æŒ‡æ ‡
- **äº‹ä»¶å¤„ç†å™¨ç›‘æ§**ï¼šç›‘æ§å„ä¸ªäº‹ä»¶å¤„ç†å™¨çš„å¥åº·çŠ¶æ€å’Œå¤„ç†èƒ½åŠ›

### 8.2 å‘Šè­¦æœºåˆ¶

- **äº‹ä»¶å¤„ç†å¤±è´¥å‘Šè­¦**ï¼šå½“äº‹ä»¶å¤„ç†å¤±è´¥ç‡è¶…è¿‡é˜ˆå€¼æ—¶è§¦å‘å‘Šè­¦
- **é˜Ÿåˆ—ç§¯å‹å‘Šè­¦**ï¼šå½“é˜Ÿåˆ—ä¸­çš„äº‹ä»¶æ•°é‡è¶…è¿‡é˜ˆå€¼æ—¶è§¦å‘å‘Šè­¦
- **äº‹ä»¶å¤„ç†å»¶è¿Ÿå‘Šè­¦**ï¼šå½“äº‹ä»¶å¤„ç†å»¶è¿Ÿè¶…è¿‡é˜ˆå€¼æ—¶è§¦å‘å‘Šè­¦

### 8.3 æ—¥å¿—ç®¡ç†

- **äº‹ä»¶æ—¥å¿—**ï¼šè®°å½•æ‰€æœ‰äº‹ä»¶çš„å‘å¸ƒå’Œå¤„ç†æƒ…å†µ
- **é”™è¯¯æ—¥å¿—**ï¼šè®°å½•äº‹ä»¶å¤„ç†è¿‡ç¨‹ä¸­çš„é”™è¯¯
- **æ€§èƒ½æ—¥å¿—**ï¼šè®°å½•äº‹ä»¶å¤„ç†çš„æ€§èƒ½æŒ‡æ ‡

## 9. æµ‹è¯•ç­–ç•¥

### 9.1 å•å…ƒæµ‹è¯•

- **äº‹ä»¶æ€»çº¿æµ‹è¯•**ï¼šæµ‹è¯•äº‹ä»¶æ€»çº¿çš„è¿æ¥ã€å‘å¸ƒã€è®¢é˜…åŠŸèƒ½
- **äº‹ä»¶å¤„ç†å™¨æµ‹è¯•**ï¼šæµ‹è¯•å„ä¸ªäº‹ä»¶å¤„ç†å™¨çš„å¤„ç†é€»è¾‘
- **ä¸­é—´ä»¶æµ‹è¯•**ï¼šæµ‹è¯•äº‹ä»¶ä¸­é—´ä»¶çš„åŠŸèƒ½

### 9.2 é›†æˆæµ‹è¯•

- **äº‹ä»¶å‘å¸ƒæµ‹è¯•**ï¼šæµ‹è¯•äº‹ä»¶ä»å‘å¸ƒåˆ°å¤„ç†çš„å®Œæ•´æµç¨‹
- **æœåŠ¡é›†æˆæµ‹è¯•**ï¼šæµ‹è¯•äº‹ä»¶é©±åŠ¨æ¶æ„ä¸ç°æœ‰æœåŠ¡çš„é›†æˆ
- **æ•…éšœæ¢å¤æµ‹è¯•**ï¼šæµ‹è¯•ç³»ç»Ÿåœ¨äº‹ä»¶å¤„ç†å¤±è´¥æ—¶çš„æ¢å¤èƒ½åŠ›

### 9.3 ç«¯åˆ°ç«¯æµ‹è¯•

- **ä¸šåŠ¡æµç¨‹æµ‹è¯•**ï¼šæµ‹è¯•å®Œæ•´çš„ä¸šåŠ¡æµç¨‹ï¼ŒåŒ…æ‹¬äº‹ä»¶çš„è§¦å‘å’Œå¤„ç†
- **æ€§èƒ½æµ‹è¯•**ï¼šæµ‹è¯•äº‹ä»¶é©±åŠ¨æ¶æ„çš„æ€§èƒ½å’Œå¯æ‰©å±•æ€§
- **å¯é æ€§æµ‹è¯•**ï¼šæµ‹è¯•äº‹ä»¶é©±åŠ¨æ¶æ„çš„å¯é æ€§å’Œå®¹é”™èƒ½åŠ›

## 10. éƒ¨ç½²å’Œé…ç½®

### 10.1 ç¯å¢ƒå˜é‡

| ç¯å¢ƒå˜é‡ | æè¿° | é»˜è®¤å€¼ |
|---------|------|-------|
| `RABBITMQ_HOST` | RabbitMQä¸»æœºåœ°å€ | `localhost` |
| `RABBITMQ_PORT` | RabbitMQç«¯å£ | `5672` |
| `RABBITMQ_USER` | RabbitMQç”¨æˆ·å | `guest` |
| `RABBITMQ_PASS` | RabbitMQå¯†ç  | `guest` |
| `RABBITMQ_VHOST` | RabbitMQè™šæ‹Ÿä¸»æœº | `/` |
| `EVENT_BUS_ENABLED` | æ˜¯å¦å¯ç”¨äº‹ä»¶æ€»çº¿ | `true` |
| `EVENT_BUS_RETRY_ATTEMPTS` | äº‹ä»¶å¤„ç†é‡è¯•æ¬¡æ•° | `3` |
| `EVENT_BUS_RETRY_DELAY` | äº‹ä»¶å¤„ç†é‡è¯•å»¶è¿Ÿ(ms) | `1000` |

### 10.2 Dockeré…ç½®

```yaml
# docker-compose.yml
version: '3.8'

services:
  rabbitmq:
    image: rabbitmq:3.12-management
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    restart: always

volumes:
  rabbitmq_data:
```

## 11. æ€»ç»“

äº‹ä»¶é©±åŠ¨æ¶æ„æ˜¯YYC3-Short-Dramaé¡¹ç›®çš„é‡è¦æŠ€æœ¯æ¶æ„ä¹‹ä¸€ï¼Œé€šè¿‡å®ç°äº‹ä»¶çš„å‘å¸ƒå’Œè®¢é˜…æœºåˆ¶ï¼Œæé«˜äº†ç³»ç»Ÿçš„æ¾è€¦åˆæ€§ã€å¯æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚æœ¬æ–¹æ¡ˆè¯¦ç»†æè¿°äº†äº‹ä»¶é©±åŠ¨æ¶æ„çš„è®¾è®¡å’Œå®ç°ï¼ŒåŒ…æ‹¬äº‹ä»¶æ€»çº¿ã€äº‹ä»¶å¤„ç†å™¨ã€ä¸­é—´ä»¶ç­‰æ ¸å¿ƒç»„ä»¶ï¼Œä»¥åŠä¸ç°æœ‰ç³»ç»Ÿçš„é›†æˆæ–¹æ¡ˆã€‚

é€šè¿‡å®æ–½äº‹ä»¶é©±åŠ¨æ¶æ„ï¼ŒYYC3-Short-Dramaé¡¹ç›®å°†å®ç°ï¼š

1. **æ¾è€¦åˆ**ï¼šå„ä¸ªæœåŠ¡ä¹‹é—´é€šè¿‡äº‹ä»¶é€šä¿¡ï¼Œå‡å°‘ç›´æ¥ä¾èµ–
2. **å¯æ‰©å±•æ€§**ï¼šå¯ä»¥è½»æ¾æ·»åŠ æ–°çš„äº‹ä»¶å¤„ç†å™¨å’Œè®¢é˜…è€…
3. **å¯é æ€§**ï¼šé€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—ç¡®ä¿äº‹ä»¶çš„å¯é ä¼ é€’
4. **å¯è§‚æµ‹æ€§**ï¼šé€šè¿‡äº‹ä»¶ç›‘æ§å’Œæ—¥å¿—ï¼Œæé«˜ç³»ç»Ÿçš„å¯è§‚æµ‹æ€§
5. **çµæ´»æ€§**ï¼šæ”¯æŒå¼‚æ­¥å¤„ç†ï¼Œæé«˜ç³»ç»Ÿçš„å“åº”é€Ÿåº¦

äº‹ä»¶é©±åŠ¨æ¶æ„çš„å®æ–½å°†ä¸ºYYC3-Short-Dramaé¡¹ç›®çš„é•¿æœŸå‘å±•å¥ å®šåšå®çš„æŠ€æœ¯åŸºç¡€ï¼Œç¬¦åˆYYCÂ³æ ‡å‡†çš„é«˜å¯ç”¨æ€§ã€é«˜æ€§èƒ½ã€é«˜å®‰å…¨æ€§ã€é«˜æ‰©å±•æ€§å’Œé«˜å¯ç»´æŠ¤æ€§è¦æ±‚ã€‚